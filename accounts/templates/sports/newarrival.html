{% load static %}
<style>
   .search-category-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 25px; /* 25px gap between flex items */
}

.category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* gap between individual category buttons */
}

.category-btn {
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 4px;
    background-color: #007bff; /* same as search button */
    color: white;
    border: none;
    transition: background 0.3s, transform 0.2s;
}

.category-btn:hover,
.category-btn.active {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.search-form {
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    flex-grow: 1;
}

.search-input {
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 4px 0 0 4px;
    flex-grow: 1;
    font-size: 14px;
}

.search-btn {
    padding: 10px 20px;
    border-radius: 0 4px 4px 0;
    border: none;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.search-btn:hover {
    background-color: #0056b3;
}



</style>
{% load static %}
<style>
   .search-category-container {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 25px;
}

.category-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
}

.category-btn {
    font-size: 16px;
    padding: 10px 20px;
    border-radius: 4px;
    background-color: #007bff;
    color: white;
    border: none;
    transition: background 0.3s, transform 0.2s;
}

.category-btn:hover,
.category-btn.active {
    background-color: #0056b3;
    transform: translateY(-2px);
}

.search-form {
    display: flex;
    flex-wrap: nowrap;
    align-items: center;
    flex-grow: 1;
    position: relative;
}

.search-wrapper {
    position: relative;
    flex-grow: 1;
}

.search-input {
    padding: 10px 12px;
    border: 1px solid #ccc;
    border-radius: 4px 0 0 4px;
    width: 100%;
    font-size: 14px;
}

.search-btn {
    padding: 10px 20px;
    border-radius: 0 4px 4px 0;
    border: none;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: background 0.3s;
}

.search-btn:hover {
    background-color: #0056b3;
}

.suggestions-dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 400px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: none;
}

.suggestions-dropdown.active {
    display: block;
}

.suggestion-item {
    padding: 12px 15px;
    cursor: pointer;
    border-bottom: 1px solid #f0f0f0;
    transition: background-color 0.2s;
}

.suggestion-item:hover,
.suggestion-item.selected {
    background-color: #f8f9fa;
}

.suggestion-item:last-child {
    border-bottom: none;
}

.suggestion-name {
    font-weight: 500;
    color: #333;
    margin-bottom: 2px;
}

.suggestion-category {
    font-size: 0.85em;
    color: #666;
}

.suggestion-type-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.75em;
    font-weight: 600;
    margin-left: 8px;
}

.badge-product {
    background-color: #e3f2fd;
    color: #1976d2;
}

.badge-category {
    background-color: #f3e5f5;
    color: #7b1fa2;
}

.no-suggestions {
    padding: 15px;
    text-align: center;
    color: #999;
}

/* Product count selector styles */
.product-count-container {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 20px;
}

.product-count-label {
    font-weight: 500;
    color: #333;
    font-size: 14px;
}

.count-buttons {
    display: flex;
    gap: 8px;
}


.count-btn {
    padding: 8px 16px;
    border: 2px solid #007bff;
    background-color: white;
    color: #007bff;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
}

.count-btn:hover {
    background-color: #f0f8ff;
    transform: translateY(-1px);
}

.count-btn.active {
    background-color: #007bff;
    color: white;
}
</style>

<section class="ftco-section bg-light">
    <div class="container">
        <div class="row justify-content-center mb-3 pb-3">
            <div class="col-md-12 heading-section text-center ftco-animate">
                <h2 class="mb-4">New Jersey Arrival</h2>
                <p>Far far away, behind the word mountains, far from the
                    countries Vokalia and Consonantia</p>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="search-category-container d-flex flex-wrap align-items-center justify-content-between">

                    <!-- Category Buttons on Left -->
                    <div class="btn-group category-buttons flex-wrap" role="group">
                        <a href="{% url 'indexSport' %}" class="btn btn-primary {% if not request.GET.category %}active{% endif %} category-btn">
                            All
                        </a>
                        {% for cat in categories %}
                            <a href="?category={{ cat.id }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.count %}&count={{ request.GET.count }}{% endif %}"
                               class="btn btn-primary {% if request.GET.category|stringformat:"s" == cat.id|stringformat:"s" %}active{% endif %} category-btn">
                                {{ cat.categoryName }}
                            </a>
                        {% endfor %}
                    </div>

                    <!-- Search Form on Right with Autocomplete -->
                    <form method="get" class="search-form d-flex ms-3 flex-grow-1">
                        {% if request.GET.category %}
                        <input type="hidden" name="category" value="{{ request.GET.category }}">
                        {% endif %}
                        {% if request.GET.count %}
                        <input type="hidden" name="count" value="{{ request.GET.count }}">
                        {% endif %}
                        
                        <div class="search-wrapper">
                            <input type="text" 
                                   name="q"
                                   id="searchInput"
                                   class="form-control search-input"
                                   placeholder="Search products or category"
                                   value="{{ request.GET.q }}"
                                   autocomplete="off">
                            
                            <div id="suggestionsDropdown" class="suggestions-dropdown"></div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary search-btn">Search</button>
                    </form>

                </div>
            </div>
        </div>


        <!-- Product Count Selector -->
        <div class="row mb-3">
            <div class="col-md-12">
                <div class="product-count-container">
                    <span class="product-count-label">Show:</span>
                    <div class="count-buttons">
                        <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}count=8" 
                           class="count-btn {% if request.GET.count == '8' or not request.GET.count %}active{% endif %}">
                            8
                        </a>
                        <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}count=16" 
                           class="count-btn {% if request.GET.count == '16' %}active{% endif %}">
                            16
                        </a>
                        <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}count=32" 
                           class="count-btn {% if request.GET.count == '32' %}active{% endif %}">
                            32
                        </a>
                        <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}count=all" 
                           class="count-btn {% if request.GET.count == 'all' %}active{% endif %}">
                            All
                        </a>
                    </div>
                    <span class="product-count-label" style="margin-left: 10px;">
                        (Showing {{ ObjDTProduct|length }} of {{ total_products }} products)
                    </span>
                </div>
            </div>
        </div>

        <div class="row">
            {% for product in ObjDTProduct %}
            <div class="col-sm-12 col-md-6 col-lg-3 ftco-animate d-flex">
                <div class="product d-flex flex-column">
                    <a href="{% url 'productsingleSport' product.id %}" class="img-prod">
                        <img class="img-fluid" src="{% static product.productImage %}" alt="Product Image">
                        <div class="overlay"></div>
                    </a>
                    <div class="text py-3 pb-4 px-3">
                        <div class="d-flex">
                            <div class="cat">
                                <span>{{ product.categoryID }}</span>
                            </div>
                            <div class="rating ml-auto">
                                <p class="text-right mb-0">
                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                    <a href="#"><span class="ion-ios-star-outline"></span></a>
                                </p>
                            </div>
                        </div>
                        <h3><a href="{% url 'productsingleSport' product.id %}">{{ product.productName }}</a></h3>
                        <div class="pricing">
                            <p class="price"><span>${{ product.price}}</span></p>
                        </div>
                        <p class="bottom-area d-flex px-3">
                            <a href="{% url 'productsingleSport' product.id %}" class="add-to-cart text-center py-2 mr-1">
                                <span>View More</span>
                            </a>
                            <a href="{% url 'add_to_cart' product.id %}" class="buy-now text-center py-2">
                                Buy now<span><i class="ion-ios-cart ml-1"></i></span>

                            </a>
                        </p>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="col-md-12 text-center">
                <p>No products found in this category.</p>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const suggestionsDropdown = document.getElementById('suggestionsDropdown');
    const searchForm = document.querySelector('.search-form');
    let selectedIndex = -1;
    let suggestions = [];
    let debounceTimer;

    function getCategoryParam() {
        const categoryInput = document.querySelector('input[name="category"]');
        return categoryInput ? categoryInput.value : '';
    }

    function fetchSuggestions(query) {
        if (query.length < 1) {
            hideSuggestions();
            return;
        }

        const category = getCategoryParam();
        const url = `/search-suggestions/?q=${encodeURIComponent(query)}${category ? '&category=' + category : ''}`;

        fetch(url)
            .then(response => response.json())
            .then(data => {
                suggestions = data.suggestions;
                displaySuggestions(suggestions);
            })
            .catch(error => {
                console.error('Error fetching suggestions:', error);
            });
    }

    function displaySuggestions(items) {
        if (items.length === 0) {
            suggestionsDropdown.innerHTML = '<div class="no-suggestions">No suggestions found</div>';
            suggestionsDropdown.classList.add('active');
            return;
        }

        const html = items.map((item, index) => `
            <div class="suggestion-item" data-index="${index}">
                <div class="suggestion-name">
                    ${highlightMatch(item.name, searchInput.value)}
                    <span class="suggestion-type-badge badge-${item.type}">
                        ${item.type}
                    </span>
                </div>
                ${item.category ? `<div class="suggestion-category">${item.category}</div>` : ''}
            </div>
        `).join('');

        suggestionsDropdown.innerHTML = html;
        suggestionsDropdown.classList.add('active');
        selectedIndex = -1;

        document.querySelectorAll('.suggestion-item').forEach(item => {
            item.addEventListener('click', function() {
                const index = parseInt(this.dataset.index);
                selectSuggestion(index);
            });
        });
    }

    function highlightMatch(text, query) {
        const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
        return text.replace(regex, '<strong>$1</strong>');
    }

    function escapeRegex(str) {
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function hideSuggestions() {
        suggestionsDropdown.classList.remove('active');
        selectedIndex = -1;
    }

    function selectSuggestion(index) {
        if (index >= 0 && index < suggestions.length) {
            searchInput.value = suggestions[index].name;
            hideSuggestions();
            searchForm.submit();
        }
    }

    function navigateSuggestions(direction) {
        const items = document.querySelectorAll('.suggestion-item');
        if (items.length === 0) return;

        if (selectedIndex >= 0 && selectedIndex < items.length) {
            items[selectedIndex].classList.remove('selected');
        }

        if (direction === 'down') {
            selectedIndex = (selectedIndex + 1) % items.length;
        } else if (direction === 'up') {
            selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
        }

        items[selectedIndex].classList.add('selected');
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
    }


    searchInput.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            fetchSuggestions(this.value.trim());
        }, 300);
    });

    searchInput.addEventListener('keydown', function(e) {
        const isDropdownVisible = suggestionsDropdown.classList.contains('active');
        
        if (!isDropdownVisible) return;

        switch(e.key) {
            case 'ArrowDown':
                e.preventDefault();
                navigateSuggestions('down');
                break;
            case 'ArrowUp':
                e.preventDefault();
                navigateSuggestions('up');
                break;
            case 'Enter':
                if (selectedIndex >= 0) {
                    e.preventDefault();
                    selectSuggestion(selectedIndex);
                }
                break;
            case 'Escape':
                hideSuggestions();
                break;
        }
    });

    document.addEventListener('click', function(e) {
        if (!searchForm.contains(e.target)) {
            hideSuggestions();
        }
    });

    searchInput.addEventListener('focus', function() {
        if (this.value.trim().length >= 1 && suggestions.length > 0) {
            suggestionsDropdown.classList.add('active');
        }
    });
});
</script>
