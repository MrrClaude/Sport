{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'sports/cssStyle.html' %}
</head>
<body class="goto-here">

{% include 'sports/menu.html' %}

<div class="hero-wrap hero-bread" style="background-image: url('{% static objbgImage.ImageURL %}');">
  <div class="container">
    <div class="row no-gutters slider-text align-items-center justify-content-center">
      <div class="col-md-9 ftco-animate text-center">
        <p class="breadcrumbs"><span class="mr-2"><a href="{% url 'indexSport' %}">Home</a></span> <span>Checkout</span></p>
        <h1 class="mb-0 bread">Checkout</h1>
      </div>
    </div>
  </div>
</div>

<section class="ftco-section">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-xl-10 ftco-animate">

        <!-- Billing Form -->
        <form method="POST" action="{% url 'billing_add' %}" enctype="multipart/form-data" class="billing-form">
          {% csrf_token %}
          <h3 class="mb-4 billing-heading">Billing Details</h3>

          <div class="row align-items-end">
            <div class="col-md-6">
              <div class="form-group">
                <label>First Name</label>
                <input type="text" name="first_name" class="form-control" required>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" name="last_name" class="form-control" required>
              </div>
            </div>

            <div class="w-100"></div>
            <div class="col-md-12">
              <div class="form-group">
                <label>Country</label>
                <select name="country" class="form-control" required>
                  <option value="France">France</option>
                  <option value="Italy">Italy</option>
                  <option value="Philippines">Philippines</option>
                  <option value="South Korea">South Korea</option>
                  <option value="Hongkong">Hongkong</option>
                  <option value="Japan">Japan</option>
                </select>
              </div>
            </div>

            <div class="w-100"></div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Street Address</label>
                <input type="text" name="address" class="form-control" required placeholder="House number and street name">
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <input type="text" name="address2" class="form-control" placeholder="Apartment, suite, unit etc: (optional)">
              </div>
            </div>

            <div class="w-100"></div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Town / City</label>
                <input type="text" name="town" class="form-control" required>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label>Postcode / ZIP *</label>
                <input type="text" name="postcode" class="form-control" required>
              </div>
            </div>

            <div class="w-100"></div>
            <div class="col-md-6">
              <div class="form-group">
                <label>Phone</label>
                <input type="text" name="phone" class="form-control" required>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label>Email Address</label>
                <input type="email" name="email" class="form-control" required>
              </div>
            </div>
          </div>

          <!-- Hidden total -->
          <input type="hidden" name="total" value="{{ total_price|floatformat:2 }}">

          <div class="row mt-5 pt-3 d-flex">

            <!-- Cart Total -->
            <div class="col-md-6 d-flex">
              <div class="cart-detail cart-total bg-light p-3 p-md-4 w-100">
                <h3 class="billing-heading mb-4">Cart Total</h3>

                {% for key, item in cart.items %}
                <p class="d-flex">
                  <span>{{ item.productName }} ({{ item.size }}) x {{ item.quantity }}</span>
                  <span>${{ item.total|floatformat:2 }}</span>
                </p>
                {% endfor %}

                <hr>
                <p class="d-flex">
                  <span>Subtotal</span>
                  <span>${{ total_price|floatformat:2 }}</span>
                </p>
                <p class="d-flex">
                  <span>Delivery</span>
                  <span>$0.00</span>
                </p>
                <p class="d-flex">
                  <span>Discount</span>
                  <span>$0.00</span>
                </p>
                <hr>
                <p class="d-flex total-price">
                  <span>Total</span>
                  <span>${{ total_price|floatformat:2 }}</span>
                </p>
              </div>
            </div>

            <!-- Payment Method -->
            <div class="col-md-6">
              <div class="cart-detail bg-light p-3 p-md-4 w-100">
                <h3 class="billing-heading mb-4">Payment Method</h3>

                                      <div class="payment-methods">
                    {% for pm in payment_methods %}
        <div class="form-group">
            <input type="radio" id="pm{{ forloop.counter }}" name="payment_method" value="{{ pm.payment_link }}" required>
            <label for="pm{{ forloop.counter }}" style="cursor:pointer;">
                {{ pm.name }}
            </label>
        </div>
    {% empty %}
        <p>No payment methods available.</p>
    {% endfor %}
                </div>
                <!-- QR Preview -->
                <div id="qr-display" style="display:none; margin-top:20px;">
                  <h5>Scan to Pay:</h5>
                  <img id="qr-image" src="" style="width:200px; border:1px solid #ddd; padding:5px; border-radius:10px;">
                </div>

                <br>
                Receipt   Image: </br><input type="file" name="qr_code_image">
                <br><br>
                <button type="submit" class="site-btn mt-3">
                  PLACE ORDER
                </button>
              </div>
            </div>

          </div>

        </form>

      </div>
    </div>
  </div>

</section>

{% include 'sports/footer.html' %}
{% include 'sports/js.html' %}

<script>
document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
    radio.addEventListener('change', function() {
        if (this.checked) {
            let paymentLink = this.value;
            let total = "{{ total_price|floatformat:2 }}";

            // Add total as query param
            if (paymentLink.includes("amount=")) {
                paymentLink = paymentLink.replace(/amount=[^&]*/g, "amount=" + total);
            } else {
                const sep = paymentLink.includes("?") ? "&" : "?";
                paymentLink = paymentLink + sep + "amount=" + total;
            }

            // Open the QR/payment link in a new tab immediately
            window.open(paymentLink, "_blank");
        }
    });
});
</script>

</body>
</html>
