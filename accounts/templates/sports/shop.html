{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    {% include 'sports/cssStyle.html' %}
    <style>
        .search-count-container {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .search-wrapper {
            position: relative;
            flex-grow: 1;
            max-width: 500px;
        }

        .search-form {
            display: flex;
            position: relative;
        }

        .search-input {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 4px 0 0 4px;
            width: 100%;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
        }

        .search-btn {
            padding: 10px 20px;
            border-radius: 0 4px 4px 0;
            border: none;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .search-btn:hover {
            background-color: #0056b3;
        }

        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .suggestions-dropdown.active {
            display: block;
        }

        .suggestion-item {
            padding: 12px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background-color: #f8f9fa;
        }

        .suggestion-name {
            font-weight: 500;
            color: #333;
        }

        .suggestion-category {
            font-size: 0.85em;
            color: #666;
            margin-top: 2px;
        }

        .suggestion-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.75em;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-product {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .badge-category {
            background-color: #f3e5f5;
            color: #7b1fa2;
        }

        .count-selector {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .count-label {
            font-weight: 500;
            color: #333;
            white-space: nowrap;
        }

        .count-buttons {
            display: flex;
            gap: 8px;
        }

        .count-btn {
            padding: 8px 16px;
            border: 2px solid #007bff;
            background-color: white;
            color: #007bff;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
        }

        .count-btn:hover {
            background-color: #f0f8ff;
            transform: translateY(-1px);
        }

        .count-btn.active {
            background-color: #007bff;
            color: white;
        }

        .product-info {
            font-size: 14px;
            color: #666;
            white-space: nowrap;
        }


        @media (max-width: 768px) {
            .search-count-container {
                flex-direction: column;
                align-items: stretch;
            }

            .search-wrapper {
                max-width: 100%;
            }

            .count-selector {
                flex-direction: column;
                align-items: flex-start;
            }

            .count-buttons {
                flex-wrap: wrap;
            }
        }
    </style>
</head>
<body class="goto-here">

    {% include 'sports/menu.html' %}

    <!-- HERO -->
    <div class="hero-wrap hero-bread" style="background-image: url('{% static objbgimage.ImageURL %}');">
        <div class="container">
            <div class="row no-gutters slider-text align-items-center justify-content-center">
                <div class="col-md-9 ftco-animate text-center">
                    <p class="breadcrumbs"><span class="mr-2">Home</span> <span>Shop</span></p>
                    <h1 class="mb-0 bread">Shop</h1>
                </div>
            </div>
        </div>
    </div>

    <!-- SHOP SECTION -->
    <section class="ftco-section bg-light">
        <div class="container">
            <div class="row">

                <!-- PRODUCTS -->
                <div class="col-md-8 col-lg-10 order-md-last">

                    <!-- SEARCH BAR & PRODUCT COUNT -->
                    <div class="search-count-container">
                        <!-- Search Form -->
                        <form method="get" class="search-form">
                            {% if request.GET.category %}
                            <input type="hidden" name="category" value="{{ request.GET.category }}">
                            {% endif %}
                            {% if request.GET.price_from %}
                            <input type="hidden" name="price_from" value="{{ request.GET.price_from }}">
                            {% endif %}
                            {% if request.GET.price_to %}
                            <input type="hidden" name="price_to" value="{{ request.GET.price_to }}">
                            {% endif %}
                            {% if request.GET.sort %}
                            <input type="hidden" name="sort" value="{{ request.GET.sort }}">
                            {% endif %}
                            {% if request.GET.count %}
                            <input type="hidden" name="count" value="{{ request.GET.count }}">
                            {% endif %}
                            
                            <div class="search-wrapper">
                                <input type="text" 
                                       name="q"
                                       id="searchInput"
                                       class="search-input"
                                       placeholder="Search products or category..."
                                       value="{{ request.GET.q }}"
                                       autocomplete="off">
                                
                                <div id="suggestionsDropdown" class="suggestions-dropdown"></div>
                            </div>
                            
                            <button type="submit" class="search-btn">
                                <i class="ion-ios-search"></i> Search
                            </button>
                        </form>


                        <!-- Product Count Selector -->
                        <div class="count-selector">
                            <span class="count-label">Show:</span>
                            <div class="count-buttons">
                                <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}count=12" 
                                   class="count-btn {% if request.GET.count == '12' or not request.GET.count %}active{% endif %}">
                                    12
                                </a>
                                <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}count=24" 
                                   class="count-btn {% if request.GET.count == '24' %}active{% endif %}">
                                    24
                                </a>
                                <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}count=48" 
                                   class="count-btn {% if request.GET.count == '48' %}active{% endif %}">
                                    48
                                </a>
                                <a href="?{% if request.GET.category %}category={{ request.GET.category }}&{% endif %}{% if request.GET.q %}q={{ request.GET.q }}&{% endif %}{% if request.GET.price_from %}price_from={{ request.GET.price_from }}&{% endif %}{% if request.GET.price_to %}price_to={{ request.GET.price_to }}&{% endif %}{% if request.GET.sort %}sort={{ request.GET.sort }}&{% endif %}count=all" 
                                   class="count-btn {% if request.GET.count == 'all' %}active{% endif %}">
                                    All
                                </a>
                            </div>
                            <span class="product-info">
                                ({{ page_obj.paginator.count }} products)
                            </span>
                        </div>
                    </div>


                    <!-- Products Grid -->
                    <div class="row">
                        {% for product in page_obj %}
                        <div class="col-sm-12 col-md-12 col-lg-4 ftco-animate d-flex">
                            <div class="product d-flex flex-column">
                                <a href="{% url 'productsingleSport' product.id %}" class="img-prod">
                                    <img class="img-fluid" src="{% static product.productImage %}" alt="{{ product.productName }}">
                                    <div class="overlay"></div>
                                </a>
                                <div class="text py-3 pb-4 px-3">
                                    <div class="d-flex">
                                        <div class="cat">
                                            <span>{{ product.categoryID.categoryName }}</span>
                                        </div>
                                        <div class="rating ml-auto">
                                            <p class="text-right mb-0">
                                                <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                <a href="#"><span class="ion-ios-star-outline"></span></a>
                                                <a href="#"><span class="ion-ios-star-outline"></span></a>
                                            </p>
                                        </div>
                                    </div>
                                    <h3>{{product.productName}}</h3>
                                    <div class="pricing">
                                        <p class="price"><span>${{ product.price }}</span></p>
                                    </div>
                                    <p class="bottom-area d-flex px-3">
                                        <a href="{% url 'productsingleSport' product.id %}" class="add-to-cart text-center py-2 mr-1">
                                            <span>View More</span>
                                        </a>
                                        <a href="{% url 'add_to_cart' product.id %}" class="buy-now text-center py-2">
                                            Buy now<span><i class="ion-ios-cart ml-1"></i></span>
                                        </a>
                                    </p>
                                </div>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-md-12 text-center">
                            <p>No products found.</p>
                        </div>
                        {% endfor %}
                    </div>


                    <!-- PAGINATION -->
                    <div class="row mt-5">
                        <div class="col text-center">
                            <div class="block-27">
                                <ul>
                                    <!-- Previous Page -->
                                    {% if page_obj.has_previous %}
                                    <li>
                                        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.price_from %}&price_from={{ request.GET.price_from }}{% endif %}{% if request.GET.price_to %}&price_to={{ request.GET.price_to }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.count %}&count={{ request.GET.count }}{% endif %}">&lt;</a>
                                    </li>
                                    {% else %}
                                    <li class="disabled"><span>&lt;</span></li>
                                    {% endif %}

                                    <!-- Page Numbers -->
                                    {% for num in page_obj.paginator.page_range %}
                                        {% if num == page_obj.number %}
                                            <li class="active"><span>{{ num }}</span></li>
                                        {% else %}
                                            <li>
                                                <a href="?page={{ num }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.price_from %}&price_from={{ request.GET.price_from }}{% endif %}{% if request.GET.price_to %}&price_to={{ request.GET.price_to }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.count %}&count={{ request.GET.count }}{% endif %}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    <!-- Next Page -->
                                    {% if page_obj.has_next %}
                                    <li>
                                        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.price_from %}&price_from={{ request.GET.price_from }}{% endif %}{% if request.GET.price_to %}&price_to={{ request.GET.price_to }}{% endif %}{% if request.GET.sort %}&sort={{ request.GET.sort }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}{% if request.GET.count %}&count={{ request.GET.count }}{% endif %}">&gt;</a>
                                    </li>
                                    {% else %}
                                    <li class="disabled"><span>&gt;</span></li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SIDEBAR -->
                <div class="col-md-4 col-lg-2">
                    <div class="sidebar">

                        <!-- CATEGORIES -->
                        <div class="sidebar-box-2">
                            <h2 class="heading">Categories</h2>
                            <ul>
                                <li><a href="{% url 'shopSport' %}">All</a></li>
                                {% for cat in categories %}
                                <li><a href="?category={{ cat.id }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.count %}&count={{ request.GET.count }}{% endif %}">{{ cat.categoryName }}</a></li>
                                {% endfor %}
                            </ul>
                        </div>


                        <!-- PRICE RANGE -->
                        <div class="sidebar-box-2">
                            <h2 class="heading">Filter</h2>
                            <form method="get" class="colorlib-form-2">
                                {% if request.GET.category %}
                                <input type="hidden" name="category" value="{{ request.GET.category }}">
                                {% endif %}
                                {% if request.GET.q %}
                                <input type="hidden" name="q" value="{{ request.GET.q }}">
                                {% endif %}
                                {% if request.GET.count %}
                                <input type="hidden" name="count" value="{{ request.GET.count }}">
                                {% endif %}
                                
                                <div class="form-group">
                                    <label>Price from:</label>
                                    <select name="price_from" class="form-control">
                                        <option value="{{ min_price }}">${{ min_price }}</option>
                                        <option value="50">$50</option>
                                        <option value="100">$100</option>
                                        <option value="200">$200</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Price to:</label>
                                    <select name="price_to" class="form-control">
                                        <option value="{{ max_price }}">${{ max_price }}</option>
                                        <option value="500">$500</option>
                                        <option value="1000">$1000</option>
                                        <option value="2000">$2000</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Sort by:</label>
                                    <select name="sort" class="form-control">
                                        <option value>Default</option>
                                        <option value="price_asc">Price: Low to High</option>
                                        <option value="price_desc">Price: High to Low</option>
                                    </select>
                                </div>
                                <button type="submit" class="btn btn-primary btn-block">Apply</button>
                            </form>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </section>

    {% include 'sports/footer.html' %}

    <!-- LOADER -->
    <div id="ftco-loader" class="show fullscreen">
        <svg class="circular" width="48px" height="48px">
            <circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee" />
            <circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00" />
        </svg>
    </div>

    {% include 'sports/js.html' %}

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('searchInput');
        const suggestionsDropdown = document.getElementById('suggestionsDropdown');
        const searchForm = document.querySelector('.search-form');
        let selectedIndex = -1;
        let suggestions = [];
        let debounceTimer;

        function getCategoryParam() {
            const categoryInput = document.querySelector('input[name="category"]');
            return categoryInput ? categoryInput.value : '';
        }

        function fetchSuggestions(query) {
            if (query.length < 1) {
                hideSuggestions();
                return;
            }


            const category = getCategoryParam();
            const url = `/search-suggestions/?q=${encodeURIComponent(query)}${category ? '&category=' + category : ''}`;

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    suggestions = data.suggestions;
                    displaySuggestions(suggestions);
                })
                .catch(error => {
                    console.error('Error fetching suggestions:', error);
                });
        }

        function displaySuggestions(items) {
            if (items.length === 0) {
                suggestionsDropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">No suggestions found</div>';
                suggestionsDropdown.classList.add('active');
                return;
            }

            const html = items.map((item, index) => `
                <div class="suggestion-item" data-index="${index}">
                    <div class="suggestion-name">
                        ${highlightMatch(item.name, searchInput.value)}
                        <span class="suggestion-type-badge badge-${item.type}">
                            ${item.type}
                        </span>
                    </div>
                    ${item.category ? `<div class="suggestion-category">${item.category}</div>` : ''}
                </div>
            `).join('');

            suggestionsDropdown.innerHTML = html;
            suggestionsDropdown.classList.add('active');
            selectedIndex = -1;

            document.querySelectorAll('.suggestion-item').forEach(item => {
                item.addEventListener('click', function() {
                    const index = parseInt(this.dataset.index);
                    selectSuggestion(index);
                });
            });
        }

        function highlightMatch(text, query) {
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<strong>$1</strong>');
        }

        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function hideSuggestions() {
            suggestionsDropdown.classList.remove('active');
            selectedIndex = -1;
        }

        function selectSuggestion(index) {
            if (index >= 0 && index < suggestions.length) {
                searchInput.value = suggestions[index].name;
                hideSuggestions();
                searchForm.submit();
            }
        }

        function navigateSuggestions(direction) {
            const items = document.querySelectorAll('.suggestion-item');
            if (items.length === 0) return;

            if (selectedIndex >= 0 && selectedIndex < items.length) {
                items[selectedIndex].classList.remove('selected');
            }

            if (direction === 'down') {
                selectedIndex = (selectedIndex + 1) % items.length;
            } else if (direction === 'up') {
                selectedIndex = selectedIndex <= 0 ? items.length - 1 : selectedIndex - 1;
            }

            items[selectedIndex].classList.add('selected');
            items[selectedIndex].scrollIntoView({ block: 'nearest' });
        }

        searchInput.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                fetchSuggestions(this.value.trim());
            }, 300);
        });

        searchInput.addEventListener('keydown', function(e) {
            const isDropdownVisible = suggestionsDropdown.classList.contains('active');
            
            if (!isDropdownVisible) return;


            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    navigateSuggestions('down');
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    navigateSuggestions('up');
                    break;
                case 'Enter':
                    if (selectedIndex >= 0) {
                        e.preventDefault();
                        selectSuggestion(selectedIndex);
                    }
                    break;
                case 'Escape':
                    hideSuggestions();
                    break;
            }
        });

        document.addEventListener('click', function(e) {
            if (!searchForm.contains(e.target)) {
                hideSuggestions();
            }
        });

        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 1 && suggestions.length > 0) {
                suggestionsDropdown.classList.add('active');
            }
        });
    });
    </script>

</body>
</html>
